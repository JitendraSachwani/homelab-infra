- name: Create media mount point
  ansible.builtin.file:
    path: /mnt/media
    state: directory
    mode: "0755"

# - name: Mount NAS media share
#   ansible.builtin.mount:
#     src: "{{ nas_ip }}:{{ nas_media_export }}"
#     path: /mnt/media
#     fstype: nfs
#     opts: rw,_netdev,noatime
#     state: mounted

- name: Create Tdarr cache directory
  ansible.builtin.file:
    path: /var/lib/tdarr-cache
    state: directory
    mode: "0755"

- name: Configure Tdarr Node
  ansible.builtin.copy:
    dest: /opt/configs/Tdarr_Node_Config.json
    owner: root
    group: root
    mode: "0644"
    content: |
      {
        "nodeName": "{{ tdarr_node_name }}",
        "serverURL": "http://{{ tdarr_server_ip }}:{{ tdarr_server_port }}",
        "serverIP": "{{ tdarr_server_ip }}",
        "serverPort": "{{ tdarr_server_port }}",
        "handbrakePath": "",
        "ffmpegPath": "",
        "mkvpropeditPath": "",
        "pathTranslators": [
          {
            "server": "",
            "node": ""
          }
        ],
        "nodeType": "mapped",
        "unmappedNodeCache": "/opt/unmappedNodeCache",
        "logLevel": "INFO",
        "priority": -1,
        "cronPluginUpdate": "",
        "apiKey": "",
        "maxLogSizeMB": 10,
        "pollInterval": 2000,
        "startPaused": false
      }

- name: Create Tdarr node systemd service
  ansible.builtin.copy:
    dest: /etc/systemd/system/tdarr-node.service
    mode: "0644"
    content: |
      [Unit]
      Description=Tdarr Node
      After=network.target

      [Service]
      Type=simple
      User=root
      WorkingDirectory={{ tdarr_install_dir }}
      ExecStart={{ tdarr_install_dir }}/Tdarr_Node
      Restart=always
      Environment=NODE_NAME={{ tdarr_node_name }}
      Environment=SERVER_IP={{ tdarr_server_ip }}
      Environment=SERVER_PORT={{ tdarr_server_port }}

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd
